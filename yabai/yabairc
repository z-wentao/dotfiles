#!/usr/bin/env sh

yabai=/opt/homebrew/bin/yabai

# ========== Scripting Addition ==========

sudo $yabai --load-sa
$yabai -m signal --add event=dock_did_restart action="sudo $yabai --load-sa"

# ========== Window Behavior ==========

$yabai -m config window_placement             second_child
$yabai -m config window_origin_display        default
$yabai -m config window_shadow                on
$yabai -m config window_animation_duration    0.00
$yabai -m config split_ratio                  0.5
$yabai -m config auto_balance                 off

# -- opacity --
$yabai -m config window_opacity               off
$yabai -m config window_opacity_duration      0.0
$yabai -m config active_window_opacity        1.0
$yabai -m config normal_window_opacity        0.5

# border: use JankyBorders if needed (window_border removed in yabai 7.x)
$yabai -m config insert_feedback_color        0xFFA3BE8C

# ========== Mouse ==========

$yabai -m config mouse_follows_focus          on
$yabai -m config focus_follows_mouse          autoraise
$yabai -m config mouse_modifier               fn
$yabai -m config mouse_action1                move
$yabai -m config mouse_action2                resize
$yabai -m config mouse_drop_action            swap

# ========== Layout & Padding ==========

$yabai -m config layout                       bsp
$yabai -m config top_padding                  0
$yabai -m config bottom_padding               32
$yabai -m config left_padding                 0
$yabai -m config right_padding                0
$yabai -m config window_gap                   0

# ========== Display-Specific Padding ==========

SKETCHYBAR_HEIGHT=28
EXTERNAL_UUID="54525BFA-482A-40BB-9C10-8EE4391233A3"

apply_display_padding() {
    spaces=$($yabai -m query --spaces)

    echo "$spaces" | jq -r '.[] | @base64' | while read -r space; do
        _jq() {
            echo "$space" | base64 --decode | jq -r "$1"
        }

        space_index=$(_jq '.index')
        display_index=$(_jq '.display')
        display_uuid=$($yabai -m query --displays --display "$display_index" | jq -r '.uuid')

        if [[ "$display_uuid" == "$EXTERNAL_UUID" ]]; then
            $yabai -m space "$space_index" --padding abs:${SKETCHYBAR_HEIGHT}:0:0:0
        else
            $yabai -m space "$space_index" --padding abs:0:0:0:0
        fi
    done
}

apply_display_padding

# ========== Window Rules: Floating ==========

$yabai -m rule --add app="^iStat"              sticky=on manage=off
$yabai -m rule --add app="^System Preferences"  manage=off
$yabai -m rule --add app="^Spotlight$"           manage=off
$yabai -m rule --add app="^Dictionary$"          manage=off
$yabai -m rule --add app="^alacritty$"          manage=off sticky=on

# ========== Window Rules: App-to-Space ==========

$yabai -m rule --add app="^iA Writer$"  space=1
$yabai -m rule --add app="^Safari"      space=3
$yabai -m rule --add app="^Claude"      space=8

# ========== Signals ==========

# terminal focused -> switch to English input
$yabai -m signal --add event=window_focused app="^iTerm2$" action="swift -e 'import Carbon; let s = TISCopyCurrentASCIICapableKeyboardInputSource().takeUnretainedValue(); TISSelectInputSource(s)'"
$yabai -m signal --add event=window_focused app="^alacritty$" action="swift -e 'import Carbon; let s = TISCopyCurrentASCIICapableKeyboardInputSource().takeUnretainedValue(); TISSelectInputSource(s)'"

# display/space change -> update padding
$yabai -m signal --add event=space_created   action="~/.config/yabai/update_padding.sh"
$yabai -m signal --add event=display_added   action="~/.config/yabai/update_padding.sh"
$yabai -m signal --add event=display_removed action="~/.config/yabai/update_padding.sh"
$yabai -m signal --add event=display_moved   action="~/.config/yabai/update_padding.sh"

# space change -> notify SketchyBar
$yabai -m signal --add event=space_changed   action="sketchybar --trigger space_change"
$yabai -m signal --add event=space_created   action="sketchybar --trigger space_change"
$yabai -m signal --add event=space_destroyed action="sketchybar --trigger space_change"

echo "yabai configuration loaded.."
